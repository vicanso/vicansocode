###*!
* Copyright(c) 2012 vicanso 腻味
* MIT Licensed
###

express = require 'express'
_ = require 'underscore'
RedisStore = require('connect-redis') express

defaultOptions =
  key : 'vicanso'
  secret : 'jenny&tree'
sessionHandleFunctions = {}
session = 
  ###*
   * [parser session的处理函数]
   * @return {[type]} [description]
  ###
  parser : () ->
    return (req, res, next) ->
      cookieParser = express.cookieParser()
      cookieParser req, res, () ->
        appName = req._info?.appName || 'all'
        session.getParser(appName) req, res, next
  ###*
   * [addParser 添加session的处理函数]
   * @param {[type]} appName [app的名字（不同的app可以有不同的处理函数，则不加，则可使用默认的处理方法）]
   * @param {[type]} options [session的存储配置（key, secret）]
  ###
  addParser : (appName, redisOptions, options) ->
    if appName
      options = _.extend {}, defaultOptions, options
      options.store = new RedisStore redisOptions
      sessionHandleFunctions[appName] = express.session options
  ###*
   * [getParser 根据app获得处理函数]
   * @param  {[type]} appName [app的名字，若不添加，则默认为'all']
   * @return {[type]}         [description]
  ###
  getParser : (appName = 'all') ->
    return sessionHandleFunctions[appName] || sessionHandleFunctions['all']

session.addParser 'all'


module.exports = session
