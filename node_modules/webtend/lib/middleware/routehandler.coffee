_ = require 'underscore'
config = require '../config'
FileImporter = require './fileimporter'
httpHandler = require './httphandler'
pageError = require './pageerror'

routeHandler = 
  ###*
   * initRoutes 初始化路由处理
   * @param  {[type]} app   [description]
   * @param  {[type]} routeInfos  [description]
   * @return {[type]}  [description]
  ###
  initRoutes : (app, routeInfos) ->
    _.each routeInfos, (routeInfo) ->
      middleware = routeInfo.middleware || []
      app[routeInfo.type] routeInfo.route, middleware, (req, res, next) ->
        debug = !config.isProductionMode
        routeInfo.handerFunc req, (err, viewData) ->
          if err
            next err
          else if viewData
            if routeInfo.jadeView
              viewData.fileImporter = new FileImporter debug
              httpHandler.render req, res, routeInfo.jadeView, viewData
            else
              if _.isObject viewData
                httpHandler.json req, res, viewData
              else
                httpHandler.response req, res, viewData
          else
            err = pageError.error 500, "#{__filename}: the viewData is null"
            next err

module.exports = routeHandler